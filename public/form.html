<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Registro - Red Social y Política</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .form-container {
            width: 100%;
            max-width: 600px;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            padding: 40px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-header h1 {
            color: #667eea;
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .form-header p {
            color: #999;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .required::after {
            content: '*';
            color: #dc3545;
            margin-left: 5px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: #f8f9ff;
        }

        .form-text {
            font-size: 12px;
            color: #999;
            margin-top: 6px;
        }

        .form-text a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .form-text a:hover {
            text-decoration: underline;
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-message {
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
        }

        /* Botones de ubicación estilizados */
        .ubicacion-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ubicacion-option {
            flex: 1;
            position: relative;
        }

        .ubicacion-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ubicacion-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            color: #666;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 50px;
        }

        .ubicacion-label:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
        }

        .ubicacion-option input[type="radio"]:checked + .ubicacion-label {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ubicacion-label i {
            margin-right: 8px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h1><i class="bi bi-people-fill"></i> Red Social y Política</h1>
                <p id="leaderInfo">Formulario de Registro</p>
            </div>

            <div class="alert alert-danger" id="errorAlert"></div>
            <div class="alert alert-success" id="successAlert">
                <i class="bi bi-check-circle"></i>
                <strong>¡Registro completado!</strong>
                <p>Tu información ha sido registrada exitosamente. Gracias por tu participación.</p>
            </div>

            <form id="publicForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required">Nombre</label>
                            <input type="text" id="firstName" placeholder="Tu nombre" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required">Apellido</label>
                            <input type="text" id="lastName" placeholder="Tu apellido" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Email <span style="color: #999;">(Opcional)</span></label>
                    <input type="email" id="email" placeholder="tu@email.com">
                    <div class="form-text">
                        Tu email nos ayudará a contactarte si es necesario
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Cédula</label>
                    <input type="text" id="cedula" placeholder="Tu número de cédula" required>
                </div>

                <div class="form-group">
                    <label class="required">Ubicación</label>
                    <div class="ubicacion-selector">
                        <div class="ubicacion-option">
                            <input type="radio" name="ubicacionTipo" id="ubicacionBogota" value="bogota" onchange="toggleUbicacion('bogota')" checked>
                            <label for="ubicacionBogota" class="ubicacion-label">
                                <i class="bi bi-buildings"></i>
                                Bogotá D.C.
                            </label>
                        </div>
                        <div class="ubicacion-option">
                            <input type="radio" name="ubicacionTipo" id="ubicacionResto" value="resto" onchange="toggleUbicacion('resto')">
                            <label for="ubicacionResto" class="ubicacion-label">
                                <i class="bi bi-geo-alt"></i>
                                Resto del país
                            </label>
                        </div>
                    </div>
                    
                    <!-- Localidades de Bogotá -->
                    <div id="bogotaContainer">
                        <label class="required">Localidad</label>
                        <select id="localidad" required>
                            <option value="">Selecciona tu localidad</option>
                            <option value="Usaquén">Usaquén</option>
                            <option value="Chapinero">Chapinero</option>
                            <option value="Santa Fe">Santa Fe</option>
                            <option value="San Cristóbal">San Cristóbal</option>
                            <option value="Usme">Usme</option>
                            <option value="Tunjuelito">Tunjuelito</option>
                            <option value="Bosa">Bosa</option>
                            <option value="Kennedy">Kennedy</option>
                            <option value="Fontibón">Fontibón</option>
                            <option value="Engativá">Engativá</option>
                            <option value="Suba">Suba</option>
                            <option value="Barrios Unidos">Barrios Unidos</option>
                            <option value="Teusaquillo">Teusaquillo</option>
                            <option value="Los Mártires">Los Mártires</option>
                            <option value="Antonio Nariño">Antonio Nariño</option>
                            <option value="Puente Aranda">Puente Aranda</option>
                            <option value="La Candelaria">La Candelaria</option>
                            <option value="Rafael Uribe Uribe">Rafael Uribe Uribe</option>
                            <option value="Ciudad Bolívar">Ciudad Bolívar</option>
                            <option value="Sumapaz">Sumapaz</option>
                        </select>
                    </div>
                    
                    <!-- Departamentos del resto del país -->
                    <div id="restoContainer" style="display: none;">
                        <label class="required">Departamento</label>
                        <select id="departamento" onchange="actualizarCapital()">
                            <option value="">Selecciona tu departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atlántico">Atlántico</option>
                            <option value="Bolívar">Bolívar</option>
                            <option value="Boyacá">Boyacá</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquetá">Caquetá</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Chocó">Chocó</option>
                            <option value="Córdoba">Córdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guainía">Guainía</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nariño">Nariño</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quindío">Quindío</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andrés y Providencia">San Andrés y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaupés">Vaupés</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        
                        <div id="capitalContainer" style="margin-top: 12px; display: none;">
                            <label>Capital</label>
                            <input type="text" id="capital" readonly style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                    </div>
                    
                    <div class="form-text">
                        ¿No sabes tu localidad?
                        <a href="https://eleccionescolombia.registraduria.gov.co/identificacion" target="_blank">
                            Click aquí para consultar en la Registraduría
                        </a>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Puesto de Votación</label>
                    <input type="text" id="votingPlace" placeholder="Ej: Colegio San José, Salón 101" required>
                    <div class="form-text">
                        El lugar donde debes ir a votar
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Número de Mesa</label>
                    <input type="text" id="votingTable" placeholder="Ej: 001" required>
                    <div class="form-text">
                        Tu número de mesa de votación
                    </div>
                </div>

                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="tel" id="phone" placeholder="+57 3XX XXX XXXX">
                    <div class="form-text">
                        Para contactarte si es necesario
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="bi bi-check-lg"></i> Enviar Registro
                </button>
            </form>

            <div class="success-message" id="successMessage">
                <div style="font-size: 60px; color: #4CAF50; margin-bottom: 20px;">
                    <i class="bi bi-check-circle"></i>
                </div>
                <h3 style="color: #333;">¡Gracias por tu registro!</h3>
                <p style="color: #999; margin: 10px 0;">
                    Tu información ha sido registrada exitosamente
                </p>
                <p style="color: #999; font-size: 12px;">
                    Serás contactado pronto por tu líder con más información
                </p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        
        // Capitales de los departamentos de Colombia
        const capitalesColombia = {
            'Amazonas': 'Leticia',
            'Antioquia': 'Medellín',
            'Arauca': 'Arauca',
            'Atlántico': 'Barranquilla',
            'Bolívar': 'Cartagena',
            'Boyacá': 'Tunja',
            'Caldas': 'Manizales',
            'Caquetá': 'Florencia',
            'Casanare': 'Yopal',
            'Cauca': 'Popayán',
            'Cesar': 'Valledupar',
            'Chocó': 'Quibdó',
            'Córdoba': 'Montería',
            'Cundinamarca': 'Bogotá D.C.',
            'Guainía': 'Inírida',
            'Guaviare': 'San José del Guaviare',
            'Huila': 'Neiva',
            'La Guajira': 'Riohacha',
            'Magdalena': 'Santa Marta',
            'Meta': 'Villavicencio',
            'Nariño': 'Pasto',
            'Norte de Santander': 'Cúcuta',
            'Putumayo': 'Mocoa',
            'Quindío': 'Armenia',
            'Risaralda': 'Pereira',
            'San Andrés y Providencia': 'San Andrés',
            'Santander': 'Bucaramanga',
            'Sucre': 'Sincelejo',
            'Tolima': 'Ibagué',
            'Valle del Cauca': 'Cali',
            'Vaupés': 'Mitú',
            'Vichada': 'Puerto Carreño'
        };
        
        // Mostrar/ocultar contenedores según ubicación
        function toggleUbicacion(tipo) {
            const bogotaContainer = document.getElementById('bogotaContainer');
            const restoContainer = document.getElementById('restoContainer');
            const localidadSelect = document.getElementById('localidad');
            const departamentoSelect = document.getElementById('departamento');
            
            if (tipo === 'bogota') {
                bogotaContainer.style.display = 'block';
                restoContainer.style.display = 'none';
                localidadSelect.required = true;
                departamentoSelect.required = false;
                departamentoSelect.value = '';
                document.getElementById('capitalContainer').style.display = 'none';
            } else {
                bogotaContainer.style.display = 'none';
                restoContainer.style.display = 'block';
                localidadSelect.required = false;
                departamentoSelect.required = true;
                localidadSelect.value = '';
            }
        }
        
        // Actualizar capital según departamento seleccionado
        function actualizarCapital() {
            const departamento = document.getElementById('departamento').value;
            const capitalContainer = document.getElementById('capitalContainer');
            const capitalInput = document.getElementById('capital');
            
            if (departamento && capitalesColombia[departamento]) {
                capitalInput.value = capitalesColombia[departamento];
                capitalContainer.style.display = 'block';
            } else {
                capitalInput.value = '';
                capitalContainer.style.display = 'none';
            }
        }
        
        let currentLeaderId = null;
        let currentEventId = null;
        let currentLeaderToken = null;

        // Validar token y cargar info del líder
        async function validateToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const leaderIdParam = urlParams.get('leaderId'); // Soporte legacy
            currentLeaderToken = token || leaderIdParam || null;

            // Si no hay token ni leaderId, es un registro general (sin líder) o error
            if (!token && !leaderIdParam) {
                return;
            }

            const lookupValue = token || leaderIdParam;

            try {
                // Usar endpoint público seguro
                const response = await fetch(`${API_URL}/api/registro/${lookupValue}`);

                if (response.ok) {
                    const leader = await response.json();
                    currentLeaderId = leader.leaderId;
                    currentEventId = leader.eventId || null;

                    let infoHtml = `Registrando con el líder: <strong style="color: #667eea">${leader.name}</strong>`;
                    if (leader.eventName) {
                        infoHtml += ` · <span style="color: #764ba2; font-weight: 600;"><i class="bi bi-calendar-event"></i> ${leader.eventName}</span>`;
                    }
                    document.getElementById('leaderInfo').innerHTML = infoHtml;
                    document.getElementById('leaderInfo').style.display = 'block';
                } else {
                    console.warn('Líder no encontrado o token inválido');
                    // No bloqueamos el formulario, pero no asignamos líder
                }
            } catch (err) {
                console.error('Error validando token:', err);
            }
        }

        // Handle form submission
        document.getElementById('publicForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const cedula = document.getElementById('cedula').value.trim();
            
            // Determinar ubicación según el tipo seleccionado
            const ubicacionTipo = document.querySelector('input[name="ubicacionTipo"]:checked').value;
            let localidad = '';
            let departamento = '';
            let capital = '';
            
            if (ubicacionTipo === 'bogota') {
                localidad = document.getElementById('localidad').value;
            } else {
                departamento = document.getElementById('departamento').value;
                capital = document.getElementById('capital').value;
                localidad = departamento; // Usar departamento como localidad para compatibilidad
            }
            
            const votingPlace = document.getElementById('votingPlace').value.trim();
            const votingTable = document.getElementById('votingTable').value.trim();
            const phone = document.getElementById('phone').value.trim();

            // Clear messages
            document.getElementById('errorAlert').classList.remove('show');

            // Validation
            const localidadValida = ubicacionTipo === 'bogota' ? localidad : departamento;
            if (!firstName || !lastName || !cedula || !localidadValida || !votingPlace || !votingTable) {
                showError('Por favor completa todos los campos requeridos');
                return;
            }

            // Disable submit button
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Procesando...';

            try {
                // Submit registration
                const payload = {
                    leaderId: currentLeaderId,
                    leaderToken: currentLeaderToken,
                    eventId: currentEventId,
                    firstName,
                    lastName,
                    email: email || null,
                    cedula,
                    phone: phone || null,
                    localidad,
                    departamento: departamento || null,
                    capital: capital || null,
                    votingPlace,
                    votingTable,
                    registeredToVote: true,
                    date: new Date().toISOString()
                };

                const response = await fetch(`${API_URL}/api/registrations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Hide form and show success
                    document.getElementById('publicForm').style.display = 'none';
                    document.getElementById('successMessage').classList.add('show');
                    document.getElementById('successAlert').classList.add('show');

                    // Reset after 5 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    const error = await response.json();
                    showError(error.error || 'Error al enviar el registro. Por favor intenta de nuevo.');
                }
            } catch (err) {
                console.error('Error:', err);
                showError('Error de conexión. Por favor intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Enviar Registro';
            }
        });

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.add('show');
            alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            validateToken();
        });
    </script>
</body>

</html>