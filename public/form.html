<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Registro - Red Social y Pol√≠tica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 120px;
        }

        .form-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-card-wrapper {
            min-height: calc(100vh - 180px);
            display: flex;
            align-items: center;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            padding: 40px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-header h1 {
            color: #667eea;
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .form-header p {
            color: #999;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .required::after {
            content: '*';
            color: #dc3545;
            margin-left: 5px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: #f8f9ff;
        }

        .form-text {
            font-size: 12px;
            color: #999;
            margin-top: 6px;
        }

        .form-text a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .form-text a:hover {
            text-decoration: underline;
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-message {
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
        }

        /* Botones de ubicaci√≥n estilizados */
        .ubicacion-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ubicacion-option {
            flex: 1;
            position: relative;
        }

        .ubicacion-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ubicacion-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            color: #666;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 50px;
        }

        .ubicacion-label:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
        }

        .ubicacion-option input[type="radio"]:checked + .ubicacion-label {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ubicacion-label i {
            margin-right: 8px;
            font-size: 16px;
        }

        /* Site Footer */
        .site-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            border-top: 1px solid #e2e8f0;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            font-size: 11px;
        }

        .footer-links {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .footer-link {
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: #64748b;
            font-size: 11px;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: #667eea;
        }

        .footer-link-primary {
            color: #667eea;
            font-weight: 500;
        }

        .footer-divider {
            color: #cbd5e1;
        }

        .footer-copyright {
            color: #94a3b8;
            font-size: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding-bottom: 80px;
            }
            
            .site-footer {
                flex-direction: column;
                gap: 4px;
                padding: 8px 12px;
            }
            
            .footer-link span {
                display: none;
            }
            
            .footer-copyright {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h1><i class="bi bi-people-fill"></i> Red Social y Pol√≠tica</h1>
                <p id="leaderInfo">Formulario de Registro</p>
            </div>

            <div class="alert alert-danger" id="errorAlert"></div>
            <div class="alert alert-success" id="successAlert">
                <i class="bi bi-check-circle"></i>
                <strong>¬°Registro completado!</strong>
                <p>Tu informaci√≥n ha sido registrada exitosamente. Gracias por tu participaci√≥n.</p>
            </div>

            <form id="publicForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required">Nombre</label>
                            <input type="text" id="firstName" placeholder="Tu nombre" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required">Apellido</label>
                            <input type="text" id="lastName" placeholder="Tu apellido" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Email <span style="color: #999;">(Opcional)</span></label>
                    <input type="email" id="email" placeholder="tu@email.com">
                    <div class="form-text">
                        Tu email nos ayudar√° a contactarte si es necesario
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">C√©dula</label>
                    <input type="text" id="cedula" placeholder="Tu n√∫mero de c√©dula" required>
                </div>

                <div class="form-group">
                    <label class="required">Ubicaci√≥n</label>
                    <div class="ubicacion-selector">
                        <div class="ubicacion-option">
                            <input type="radio" name="ubicacionTipo" id="ubicacionBogota" value="bogota" onchange="toggleUbicacion('bogota')" checked>
                            <label for="ubicacionBogota" class="ubicacion-label">
                                <i class="bi bi-buildings"></i>
                                Bogot√° D.C.
                            </label>
                        </div>
                        <div class="ubicacion-option">
                            <input type="radio" name="ubicacionTipo" id="ubicacionResto" value="resto" onchange="toggleUbicacion('resto')">
                            <label for="ubicacionResto" class="ubicacion-label">
                                <i class="bi bi-geo-alt"></i>
                                Resto del pa√≠s
                            </label>
                        </div>
                    </div>
                    
                    <!-- Localidades de Bogot√° -->
                    <div id="bogotaContainer">
                        <label class="required">Localidad</label>
                        <select id="localidad" required onchange="cargarPuestos()">
                            <option value="">Selecciona tu localidad</option>
                            <option value="Usaqu√©n">Usaqu√©n</option>
                            <option value="Chapinero">Chapinero</option>
                            <option value="Santa Fe">Santa Fe</option>
                            <option value="San Crist√≥bal">San Crist√≥bal</option>
                            <option value="Usme">Usme</option>
                            <option value="Tunjuelito">Tunjuelito</option>
                            <option value="Bosa">Bosa</option>
                            <option value="Kennedy">Kennedy</option>
                            <option value="Fontib√≥n">Fontib√≥n</option>
                            <option value="Engativ√°">Engativ√°</option>
                            <option value="Suba">Suba</option>
                            <option value="Barrios Unidos">Barrios Unidos</option>
                            <option value="Teusaquillo">Teusaquillo</option>
                            <option value="Los M√°rtires">Los M√°rtires</option>
                            <option value="Antonio Nari√±o">Antonio Nari√±o</option>
                            <option value="Puente Aranda">Puente Aranda</option>
                            <option value="La Candelaria">La Candelaria</option>
                            <option value="Rafael Uribe Uribe">Rafael Uribe Uribe</option>
                            <option value="Ciudad Bol√≠var">Ciudad Bol√≠var</option>
                            <option value="Sumapaz">Sumapaz</option>
                        </select>
                    </div>
                    
                    <!-- Departamentos del resto del pa√≠s -->
                    <div id="restoContainer" style="display: none;">
                        <label class="required">Departamento</label>
                        <select id="departamento" onchange="actualizarCapital()">
                            <option value="">Selecciona tu departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atl√°ntico">Atl√°ntico</option>
                            <option value="Bol√≠var">Bol√≠var</option>
                            <option value="Boyac√°">Boyac√°</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquet√°">Caquet√°</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Choc√≥">Choc√≥</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guain√≠a">Guain√≠a</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nari√±o">Nari√±o</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quind√≠o">Quind√≠o</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaup√©s">Vaup√©s</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        
                        <div id="capitalContainer" style="margin-top: 12px; display: none;">
                            <label>Capital</label>
                            <input type="text" id="capital" readonly style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                    </div>
                    
                    <div class="form-text">
                        ¬øNo sabes tu localidad?
                        <a href="https://eleccionescolombia.registraduria.gov.co/identificacion" target="_blank">
                            Click aqu√≠ para consultar en la Registradur√≠a
                        </a>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Puesto de Votaci√≥n</label>
                    <div style="position: relative;">
                        <input type="text" id="puestoBusqueda" placeholder="üîç Escribe para buscar o click para ver opciones..." autocomplete="off" style="width: 100%;" onkeyup="filtrarPuestos()" onfocus="mostrarDropdownPuestos()" onclick="mostrarDropdownPuestos()">
                        <div id="puestoDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-radius: 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 4px;">
                        </div>
                        <input type="hidden" id="puestoId" required>
                    </div>
                    <div class="form-text">
                        El lugar donde debes ir a votar
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">N√∫mero de Mesa</label>
                    <input type="number" id="mesa" required placeholder="Ingresa tu n√∫mero de mesa" min="1">
                    <div class="form-text">
                        Consulta el n√∫mero en tu documento de identidad
                    </div>
                </div>

                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="phone" placeholder="+57 3XX XXX XXXX">
                    <div class="form-text">
                        Para contactarte si es necesario
                    </div>
                </div>

                <!-- CONSENT CHECKBOX (Ley 1581 de 2012) -->
                <div class="consent-section" style="background: linear-gradient(135deg, #fff9e6 0%, #fff5cc 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" id="hasConsentToRegister" required style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer; accent-color: #667eea; flex-shrink: 0;">
                        <span style="font-size: 13px; color: #495057; line-height: 1.6; text-align: justify;">
                            <strong style="color: #92400e;">Declaro bajo juramento</strong> que tengo la autorizaci√≥n previa e informada del titular para registrar su informaci√≥n, incluyendo sus preferencias para fines de estudio estad√≠stico y de informaci√≥n. <strong style="color: #92400e;">Asumo la responsabilidad legal de esta recolecci√≥n.</strong>
                            <a href="#" onclick="showConsentPolicyModal(event)" style="color: #667eea; font-weight: 600; display: inline-block; margin-top: 4px;">[Leer Pol√≠ticas]</a>
                        </span>
                    </label>
                    <div id="consentError" style="display: none; color: #dc2626; font-size: 12px; margin-top: 8px; padding: 8px; background: #fee2e2; border-radius: 6px; text-align: center;">
                        <i class="bi bi-exclamation-triangle"></i> Marca esta casilla de campo obligatorio si quieres continuar
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="bi bi-check-lg"></i> Enviar Registro
                </button>
            </form>

            <div class="success-message" id="successMessage">
                <div style="font-size: 60px; color: #4CAF50; margin-bottom: 20px;">
                    <i class="bi bi-check-circle"></i>
                </div>
                <h3 style="color: #333;">¬°Gracias por tu registro!</h3>
                <p style="color: #999; margin: 10px 0;">
                    Tu informaci√≥n ha sido registrada exitosamente
                </p>
                <p style="color: #999; font-size: 12px;">
                    Ser√°s contactado pronto por tu l√≠der con m√°s informaci√≥n
                </p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        
        // Capitales de los departamentos de Colombia
        const capitalesColombia = {
            'Amazonas': 'Leticia',
            'Antioquia': 'Medell√≠n',
            'Arauca': 'Arauca',
            'Atl√°ntico': 'Barranquilla',
            'Bol√≠var': 'Cartagena',
            'Boyac√°': 'Tunja',
            'Caldas': 'Manizales',
            'Caquet√°': 'Florencia',
            'Casanare': 'Yopal',
            'Cauca': 'Popay√°n',
            'Cesar': 'Valledupar',
            'Choc√≥': 'Quibd√≥',
            'C√≥rdoba': 'Monter√≠a',
            'Cundinamarca': 'Bogot√° D.C.',
            'Guain√≠a': 'In√≠rida',
            'Guaviare': 'San Jos√© del Guaviare',
            'Huila': 'Neiva',
            'La Guajira': 'Riohacha',
            'Magdalena': 'Santa Marta',
            'Meta': 'Villavicencio',
            'Nari√±o': 'Pasto',
            'Norte de Santander': 'C√∫cuta',
            'Putumayo': 'Mocoa',
            'Quind√≠o': 'Armenia',
            'Risaralda': 'Pereira',
            'San Andr√©s y Providencia': 'San Andr√©s',
            'Santander': 'Bucaramanga',
            'Sucre': 'Sincelejo',
            'Tolima': 'Ibagu√©',
            'Valle del Cauca': 'Cali',
            'Vaup√©s': 'Mit√∫',
            'Vichada': 'Puerto Carre√±o'
        };
        
        // Mostrar/ocultar contenedores seg√∫n ubicaci√≥n
        function toggleUbicacion(tipo) {
            const bogotaContainer = document.getElementById('bogotaContainer');
            const restoContainer = document.getElementById('restoContainer');
            const localidadSelect = document.getElementById('localidad');
            const departamentoSelect = document.getElementById('departamento');
            
            if (tipo === 'bogota') {
                bogotaContainer.style.display = 'block';
                restoContainer.style.display = 'none';
                localidadSelect.required = true;
                departamentoSelect.required = false;
                departamentoSelect.value = '';
                document.getElementById('capitalContainer').style.display = 'none';
            } else {
                bogotaContainer.style.display = 'none';
                restoContainer.style.display = 'block';
                localidadSelect.required = false;
                departamentoSelect.required = true;
                localidadSelect.value = '';
            }
        }
        
        // Actualizar capital seg√∫n departamento seleccionado
        function actualizarCapital() {
            const departamento = document.getElementById('departamento').value;
            const capitalContainer = document.getElementById('capitalContainer');
            const capitalInput = document.getElementById('capital');
            
            if (departamento && capitalesColombia[departamento]) {
                capitalInput.value = capitalesColombia[departamento];
                capitalContainer.style.display = 'block';
            } else {
                capitalInput.value = '';
                capitalContainer.style.display = 'none';
            }
        }
        
        // Cargar puestos de votaci√≥n seg√∫n localidad
        let puestosCache = []; // Cache para filtrado
        
        async function cargarPuestos() {
            const localidad = document.getElementById('localidad').value;
            const ubicacionTipo = document.querySelector('input[name="ubicacionTipo"]:checked')?.value;
            
            console.log('üîç cargarPuestos llamada:', {localidad, ubicacionTipo});
            
            if (!localidad || ubicacionTipo !== 'bogota') {
                console.log('‚ùå Localidad vac√≠a o no es Bogot√°');
                document.getElementById('puestoId').innerHTML = '<option value="">Selecciona tu puesto de votaci√≥n</option>';
                document.getElementById('mesa').value = '';
                document.getElementById('puestoBusqueda').value = '';
                puestosCache = [];
                return;
            }
            
            try {
                // Usar la ruta p√∫blica sin token
                const url = `/api/public/puestos?localidad=${encodeURIComponent(localidad)}`;
                console.log('üì° Llamando API:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('‚ùå Error (status):', response.status, response.statusText);
                    if (response.status === 404) {
                        showError('No se encontraron puestos para esta localidad. Por favor intenta m√°s tarde.');
                    } else {
                        showError('Error al cargar puestos de votaci√≥n');
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ API Response:', data);
                puestosCache = data.data || [];
                console.log('üì¶ Puestos en cache:', puestosCache.length);
                
                if (puestosCache.length === 0) {
                    console.log('‚ö†Ô∏è  Sin puestos para esta localidad');
                    document.getElementById('puestoId').innerHTML = '<option value="">No hay puestos disponibles</option>';
                    return;
                }
                
                // Mostrar puestos
                console.log('üéØ Llamando mostrarPuestosFiltrables()');
                mostrarPuestosFiltrables();
                document.getElementById('puestoBusqueda').value = '';
                document.getElementById('mesa').value = '';
            } catch (error) {
                console.error('Error al cargar puestos:', error);
                showError('Error de conexi√≥n al cargar puestos');
            }
        }
        
        function normalizePuestoTexto(value) {
            return (value || '')
                .normalize('NFD')
                .replace(/\p{Diacritic}/gu, '')
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function buildPuestoSearchText(puesto) {
            const aliases = Array.isArray(puesto.aliases) ? puesto.aliases.join(' ') : '';
            const base = `${puesto.nombre || ''} ${puesto.codigoPuesto || ''} ${aliases}`;
            return normalizePuestoTexto(base);
        }

        // Filtrar puestos por nombre
        function filtrarPuestos() {
            const terminoRaw = document.getElementById('puestoBusqueda').value;
            const termino = normalizePuestoTexto(terminoRaw);
            
            let puestosAMostrar = termino 
                ? puestosCache.filter(p => buildPuestoSearchText(p).includes(termino))
                : puestosCache;
            
            const dropdown = document.getElementById('puestoDropdown');
            
            if (puestosAMostrar.length === 0) {
                dropdown.innerHTML = '<div style="padding: 12px; color: #999; text-align: center;">No hay resultados</div>';
            } else {
                dropdown.innerHTML = puestosAMostrar.slice(0, 50).map(p => `
                    <div class="puesto-option" data-id="${p._id}" data-nombre="${p.nombre}" onclick="seleccionarPuesto('${p._id}', '${(p.nombre || '').replace(/'/g, "\\'")}', '${p.codigoPuesto || ''}')" style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='white'">
                        <strong>${p.nombre || 'Sin nombre'}</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 8px;">${p.codigoPuesto || ''}</span>
                    </div>
                `).join('');
            }
            
            dropdown.style.display = 'block';
        }
        
        // Mostrar dropdown con todos los puestos
        function mostrarDropdownPuestos() {
            filtrarPuestos();
        }
        
        // Seleccionar un puesto del dropdown
        function seleccionarPuesto(id, nombre, codigo) {
            document.getElementById('puestoBusqueda').value = `${nombre} (${codigo})`;
            document.getElementById('puestoId').value = id;
            document.getElementById('puestoDropdown').style.display = 'none';
            cargarMesas();
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(e) {
            const container = document.getElementById('puestoBusqueda')?.parentElement;
            if (container && !container.contains(e.target)) {
                const dropdown = document.getElementById('puestoDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
        
        // Mostrar todos los puestos (actualizado para dropdown)
        function mostrarPuestosFiltrables() {
            filtrarPuestos();
        }
        
        // Cargar mesas seg√∫n puesto seleccionado
        async function cargarMesas() {
            const puestoId = document.getElementById('puestoId').value;
            if (!puestoId) {
                document.getElementById('mesa').value = '';
            }
        }
        
        let currentLeaderId = null;
        let currentEventId = null;
        let currentLeaderToken = null;

        // Validar token y cargar info del l√≠der
        async function validateToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const leaderIdParam = urlParams.get('leaderId'); // Soporte legacy
            currentLeaderToken = token || leaderIdParam || null;

            // Si no hay token ni leaderId, es un registro general (sin l√≠der) o error
            if (!token && !leaderIdParam) {
                return;
            }

            const lookupValue = token || leaderIdParam;

            try {
                // Usar endpoint p√∫blico seguro
                const response = await fetch(`${API_URL}/api/registro/${lookupValue}`);

                if (response.ok) {
                    const leader = await response.json();
                    currentLeaderId = leader.leaderId;
                    currentEventId = leader.eventId || null;

                    let infoHtml = `Registrando con el l√≠der: <strong style="color: #667eea">${leader.name}</strong>`;
                    if (leader.eventName) {
                        infoHtml += ` ¬∑ <span style="color: #764ba2; font-weight: 600;"><i class="bi bi-calendar-event"></i> ${leader.eventName}</span>`;
                    }
                    document.getElementById('leaderInfo').innerHTML = infoHtml;
                    document.getElementById('leaderInfo').style.display = 'block';
                } else {
                    console.warn('L√≠der no encontrado o token inv√°lido');
                    // No bloqueamos el formulario, pero no asignamos l√≠der
                }
            } catch (err) {
                console.error('Error validando token:', err);
            }
        }

        // Handle form submission
        document.getElementById('publicForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Verificar consentimiento (Ley 1581 de 2012)
            const consentCheckbox = document.getElementById('hasConsentToRegister');
            const consentError = document.getElementById('consentError');
            
            if (!consentCheckbox.checked) {
                consentError.style.display = 'block';
                consentCheckbox.parentElement.parentElement.style.borderColor = '#dc2626';
                consentCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            } else {
                consentError.style.display = 'none';
                consentCheckbox.parentElement.parentElement.style.borderColor = '#f59e0b';
            }

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const cedula = document.getElementById('cedula').value.trim();
            
            // Determinar ubicaci√≥n seg√∫n el tipo seleccionado
            const ubicacionTipo = document.querySelector('input[name="ubicacionTipo"]:checked').value;
            let localidad = '';
            let departamento = '';
            let capital = '';
            
            if (ubicacionTipo === 'bogota') {
                localidad = document.getElementById('localidad').value;
            } else {
                departamento = document.getElementById('departamento').value;
                capital = document.getElementById('capital').value;
                localidad = departamento;
            }
            
            const puestoId = document.getElementById('puestoId').value;
            const mesa = document.getElementById('mesa').value.trim();
            const phone = document.getElementById('phone').value.trim();

            document.getElementById('errorAlert').classList.remove('show');

            const localidadValida = ubicacionTipo === 'bogota' ? localidad : departamento;
            if (!firstName || !lastName || !cedula || !localidadValida || !puestoId || !mesa) {
                showError('Por favor completa todos los campos requeridos');
                return;
            }

            if (ubicacionTipo === 'bogota' && !puestoId) {
                showError('Por favor selecciona un puesto de votaci√≥n');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Procesando...';

            try {
                const payload = {
                    leaderId: currentLeaderId,
                    leaderToken: currentLeaderToken,
                    eventId: currentEventId,
                    firstName,
                    lastName,
                    email: email || null,
                    cedula,
                    phone: phone || null,
                    localidad,
                    departamento: departamento || null,
                    capital: capital || null,
                    puestoId,
                    mesa: parseInt(mesa),
                    registeredToVote: true,
                    date: new Date().toISOString(),
                    hasConsentToRegister: true
                };

                const response = await fetch(`${API_URL}/api/registrations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    document.getElementById('publicForm').style.display = 'none';
                    document.getElementById('successMessage').classList.add('show');
                    document.getElementById('successAlert').classList.add('show');

                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    const error = await response.json();
                    showError(error.error || 'Error al enviar el registro. Por favor intenta de nuevo.');
                }
            } catch (err) {
                console.error('Error:', err);
                showError('Error de conexi√≥n. Por favor intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Enviar Registro';
            }
        });

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.add('show');
            alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Show consent policy modal (Ley 1581 de 2012)
        function showConsentPolicyModal(event) {
            if (event) event.preventDefault();
            
            const modal = document.createElement('div');
            modal.id = 'consentPolicyModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #667eea; font-size: 20px;">Pol√≠tica de Tratamiento de Datos</h3>
                        <button onclick="document.getElementById('consentPolicyModal').remove()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer;">&times;</button>
                    </div>
                    <div style="padding: 24px; color: #374151; font-size: 14px; line-height: 1.7;">
                        <h4 style="color: #667eea; margin: 0 0 12px 0;">1. Responsable del Tratamiento</h4>
                        <p style="margin: 0 0 16px 0;">Los datos personales recolectados son tratados bajo la responsabilidad del administrador del sistema, conforme a la Ley 1581 de 2012.</p>
                        
                        <h4 style="color: #667eea; margin: 0 0 12px 0;">2. Finalidad</h4>
                        <p style="margin: 0 0 16px 0;">Los datos ser√°n utilizados exclusivamente para:</p>
                        <ul style="margin: 0 0 16px 0; padding-left: 20px;">
                            <li>Estudio de informaci√≥n y an√°lisis estad√≠stico</li>
                            <li>Consolidaci√≥n de m√©tricas</li>
                            <li>Gesti√≥n de participaci√≥n ciudadana</li>
                        </ul>
                        
                        <h4 style="color: #667eea; margin: 0 0 12px 0;">3. Datos Sensibles</h4>
                        <p style="margin: 0 0 16px 0;">De conformidad con el art√≠culo 7 de la Ley 1581 de 2012, podr√≠an recolectarse datos que revelen preferencias pol√≠ticas. Estos requieren autorizaci√≥n previa, expresa e informada del titular.</p>
                        
                        <h4 style="color: #667eea; margin: 0 0 12px 0;">4. Derechos del Titular</h4>
                        <p style="margin: 0;">Tienes derecho a conocer, actualizar y rectificar tus datos; solicitar prueba de autorizaci√≥n; revocar la autorizaci√≥n; y presentar quejas ante la SIC.</p>
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #e5e7eb; text-align: center;">
                        <button onclick="document.getElementById('consentPolicyModal').remove()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            validateToken();
        });
    </script>

    <!-- FOOTER LEGAL -->
    <footer class="site-footer">
        <div class="footer-links">
            <a href="https://www.sic.gov.co" target="_blank" rel="noopener noreferrer" class="footer-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                <span>SIC</span>
            </a>
            <span class="footer-divider">|</span>
            <a href="#" onclick="showConsentPolicyModal(event)" class="footer-link footer-link-primary">
                <i class="bi bi-shield-check"></i> Pol√≠tica de Datos
            </a>
        </div>
        <span class="footer-copyright">¬© 2026 Red Social y Pol√≠tica</span>
    </footer>
</body>

</html>