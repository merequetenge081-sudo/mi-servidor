<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Social y Política - Dashboard Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --light-bg: #f5f7fb;
            --white: #ffffff;
            --dark-sidebar: #1a1a2e;
            --text-dark: #1a1a1a;
            --text-muted: #999;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-bg);
            display: flex;
        }
        
        /* ============== SIDEBAR ============== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--dark-sidebar);
            color: white;
            overflow-y: auto;
            z-index: 100;
            padding: 20px 0;
        }
        
        .sidebar-brand {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-brand h5 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            color: var(--primary);
        }
        
        .sidebar nav a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            gap: 12px;
        }
        
        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: rgba(102,126,234,0.15);
            color: white;
            border-left-color: var(--primary);
        }
        
        .sidebar nav a i {
            font-size: 18px;
        }
        
        /* ============== MAIN CONTENT ============== */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ============== NAVBAR ============== */
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 20px;
        }
        
        .navbar-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .btn-logout {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: opacity 0.3s;
        }
        
        .btn-logout:hover {
            opacity: 0.8;
        }
        
        /* ============== CONTENT AREA ============== */
        .content {
            flex: 1;
            padding: 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* ============== CARDS ============== */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            padding: 20px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* ============== STATS ============== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 10px 0;
            color: var(--primary);
            font-size: 32px;
            font-weight: 700;
        }
        
        .stat-card p {
            color: var(--text-muted);
            font-size: 14px;
            margin: 0;
        }
        
        /* ============== TABLES ============== */
        .table {
            margin: 0;
        }
        
        .table thead th {
            background: #f0f0f0;
            color: var(--text-dark);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
            padding: 15px;
        }
        
        .table tbody td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .table tbody tr:hover {
            background: #f9f9f9;
        }
        
        /* ============== BUTTONS ============== */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102,126,234,0.3);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* ============== FORMS ============== */
        .form-control, .form-select {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(102,126,234,0.25);
            outline: none;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        /* ============== MODALS ============== */
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
        }
        
        /* ============== FILTERS ============== */
        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        /* ============== REPONSIVE ============== */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .navbar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ============== SIDEBAR ============== -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <h5><i class="bi bi-people-fill"></i> Red Social y Política</h5>
        </div>
        <nav>
            <a href="#" class="nav-link active" data-section="dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-link" data-section="lideres">
                <i class="bi bi-person-badge"></i>
                <span>Gestión de Líderes</span>
            </a>
            <a href="#" class="nav-link" data-section="registros">
                <i class="bi bi-clipboard-data"></i>
                <span>Registros</span>
            </a>
            <a href="#" class="nav-link" data-section="exportar">
                <i class="bi bi-download"></i>
                <span>Exportar Datos</span>
            </a>
            <a href="#" class="nav-link" data-section="analisis">
                <i class="bi bi-graph-up"></i>
                <span>Análisis de Datos</span>
            </a>
            <a href="#" class="nav-link" data-section="formulario">
                <i class="bi bi-form-check"></i>
                <span>Ver Formulario Público</span>
            </a>
        </nav>
    </div>

    <!-- ============== MAIN CONTENT ============== -->
    <div class="main-content">
        <!-- ============== NAVBAR ============== -->
        <div class="navbar">
            <div class="navbar-brand">
                <i class="bi bi-house-fill"></i> Red Social y Política
            </div>
            <div class="navbar-actions">
                <span id="userName">Admin</span>
                <button class="btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>

        <!-- ============== CONTENT ============== -->
        <div class="content">
            <!-- ===== DASHBOARD ===== -->
            <div id="dashboard" class="section active">
                <h2 class="mb-4">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="bi bi-people" style="font-size: 32px; color: var(--primary);"></i>
                        <h3 id="statLideres">0</h3>
                        <p>Líderes Activos</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-clipboard-check" style="font-size: 32px; color: var(--primary);"></i>
                        <h3 id="statRegistros">0</h3>
                        <p>Registros Totales</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-check-circle" style="font-size: 32px; color: #4CAF50;"></i>
                        <h3 id="statConfirmados">0</h3>
                        <p>Registros Confirmados</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-calendar-event" style="font-size: 32px; color: var(--primary);"></i>
                        <h3 id="statEventos">0</h3>
                        <p>Eventos Activos</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Registros Recientes
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Líder Asociado</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="recentRegistrationsTable">
                                    <tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== GESTIÓN DE LÍDERES ===== -->
            <div id="lideres" class="section">
                <h2 class="mb-4">
                    <i class="bi bi-person-badge"></i> Gestión de Líderes
                </h2>

                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#leaderModal">
                    <i class="bi bi-plus-lg"></i> Nuevo Líder
                </button>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list"></i> Lista de Líderes
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Registros</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="leadersTable">
                                    <tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== REGISTROS ===== -->
            <div id="registros" class="section">
                <h2 class="mb-4">
                    <i class="bi bi-clipboard-data"></i> Registros
                </h2>

                <div class="filters">
                    <div class="filter-group">
                        <label class="form-label">Buscar por nombre o email</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Nombre o email...">
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Filtrar por líder</label>
                        <select class="form-select" id="filterLeader">
                            <option value="">Todos los líderes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">Todos</option>
                            <option value="confirmed">Confirmados</option>
                            <option value="pending">Pendientes</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-table"></i> Todos los Registros
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Cédula</th>
                                        <th>Lugar Votación</th>
                                        <th>Líder</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTable">
                                    <tr><td colspan="8" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== EXPORTAR DATOS ===== -->
            <div id="exportar" class="section">
                <h2 class="mb-4">
                    <i class="bi bi-download"></i> Exportar Datos
                </h2>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-clipboard-check"></i> Exportar Registros
                            </div>
                            <div class="card-body">
                                <p>Descargar todos los registros en formato Excel</p>
                                <button class="btn btn-primary w-100" onclick="exportRegistrations()">
                                    <i class="bi bi-download"></i> Descargar Registros Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-person-badge"></i> Exportar Líderes
                            </div>
                            <div class="card-body">
                                <p>Descargar información de todos los líderes</p>
                                <button class="btn btn-primary w-100" onclick="exportLeaders()">
                                    <i class="bi bi-download"></i> Descargar Líderes Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <i class="bi bi-box-arrow-down"></i> Exportación por Líder
                    </div>
                    <div class="card-body">
                        <label class="form-label">Selecciona un líder para exportar sus registros</label>
                        <div class="input-group mb-3">
                            <select class="form-select" id="leaderSelectExport">
                                <option value="">Selecciona un líder...</option>
                            </select>
                            <button class="btn btn-primary" onclick="exportLeaderData()">
                                <i class="bi bi-download"></i> Exportar Registros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== ANÁLISIS DE DATOS ===== -->
            <div id="analisis" class="section">
                <h2 class="mb-4">
                    <i class="bi bi-graph-up"></i> Análisis de Datos
                </h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="bi bi-percent" style="font-size: 32px; color: var(--primary);"></i>
                        <h3 id="analysisTasaConfirmacion">0%</h3>
                        <p>Tasa de Confirmación</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-calendar-check" style="font-size: 32px; color: var(--primary);"></i>
                        <h3 id="analysisPromedioRegistros">0</h3>
                        <p>Promedio Registros/Líder</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-pin-map" style="font-size: 32px; color: var(--primary);"></i>
                        <h3 id="analysisLocalidades">0</h3>
                        <p>Localidades Cubiertas</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart"></i> Producción por Líder
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Líder</th>
                                        <th>Registros</th>
                                        <th>Confirmados</th>
                                        <th>% Confirmación</th>
                                        <th>Localidades</th>
                                    </tr>
                                </thead>
                                <tbody id="analysisLidersTable">
                                    <tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-geo-alt"></i> Registros por Localidad
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Localidad</th>
                                        <th>Registros</th>
                                        <th>% del Total</th>
                                    </tr>
                                </thead>
                                <tbody id="analysisLocalidadesTable">
                                    <tr><td colspan="3" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== FORMULARIO PÚBLICO ===== -->
            <div id="formulario" class="section">
                <h2 class="mb-4">
                    <i class="bi bi-form-check"></i> Formulario Público
                </h2>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> Vista Previa del Formulario Público
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 offset-md-3">
                                <div class="card border">
                                    <div class="card-body">
                                        <h5 class="card-title mb-4">Formulario de Registro</h5>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Nombre *</label>
                                            <input type="text" class="form-control" placeholder="Tu nombre completo">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Email (Opcional)</label>
                                            <input type="email" class="form-control" placeholder="tu@email.com">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Cédula *</label>
                                            <input type="text" class="form-control" placeholder="Tu número de cédula">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Lugar de Votación *</label>
                                            <select class="form-select">
                                                <option>Selecciona tu lugar de votación</option>
                                                <option>Usaquén</option>
                                                <option>Chapinero</option>
                                                <option>La Candelaria</option>
                                                <option>San Cristóbal</option>
                                                <option>Usme</option>
                                                <option>Tunjuelito</option>
                                                <option>Bosa</option>
                                                <option>Kennedy</option>
                                                <option>Fontibón</option>
                                                <option>Engativá</option>
                                                <option>Suba</option>
                                                <option>Barrios Unidos</option>
                                                <option>Teusaquillo</option>
                                                <option>Los Mártires</option>
                                                <option>Antonio Nariño</option>
                                                <option>Puente Aranda</option>
                                                <option>La Sabana</option>
                                                <option>Simmonds</option>
                                                <option>Palermo</option>
                                                <option>Rafael Uribe</option>
                                            </select>
                                            <small class="text-muted">
                                                ¿No sabes tu puesto de votación? 
                                                <a href="https://www.registraduria.gov.co/buscar-puesto-votacion" target="_blank">
                                                    Click aquí
                                                </a>
                                            </small>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Puesto de Votación *</label>
                                            <input type="text" class="form-control" placeholder="Ej: Escuela X, Salón 5">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Número de Mesa *</label>
                                            <input type="text" class="form-control" placeholder="Ej: 001">
                                        </div>

                                        <button class="btn btn-primary w-100">
                                            <i class="bi bi-check-lg"></i> Enviar Registro
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============== MODALS ============== -->
    <!-- Modal Crear/Editar Líder -->
    <div class="modal fade" id="leaderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Nuevo Líder
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="leaderName" placeholder="Nombre del líder">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="leaderEmail" placeholder="email@example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="leaderPhone" placeholder="+57 3XX XXX XXXX">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Área</label>
                        <input type="text" class="form-control" id="leaderArea" placeholder="Área o zona asignada">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLeader()">
                        <i class="bi bi-check-lg"></i> Guardar Líder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver QR -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-qr-code"></i> QR del Líder
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrCodeContainer" style="margin: 20px 0;"></div>
                    <div class="mb-3">
                        <label class="form-label">Link de Registro</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="registrationLink" readonly>
                            <button class="btn btn-outline-primary" onclick="copyLink()">
                                <i class="bi bi-clipboard"></i> Copiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>

    <script>
        const API_URL = window.location.origin;
        let allLeaders = [];
        let allRegistrations = [];
        let currentToken = localStorage.getItem('token');

        // ============== AUTHENTICATION ============== 
        function checkAuth() {
            if (!currentToken) {
                window.location.href = '/';
                return;
            }
        }

        function logout() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('role');
                window.location.href = '/';
            }
        }

        // ============== API CALLS ==============
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentToken}`,
                ...options.headers
            };
            
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers
            });

            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/';
            }

            return response;
        }

        // ============== LOAD DATA ==============
        async function loadDashboard() {
            try {
                // Load leaders
                const leadersRes = await apiCall('/api/leaders');
                allLeaders = await leadersRes.json();

                // Load registrations
                const regsRes = await apiCall('/api/registrations');
                allRegistrations = await regsRes.json();

                // Update stats
                updateStats();
                loadLeadersTable();
                loadRegistrationsTable();
                loadAnalysis();
            } catch (err) {
                console.error('Error loading dashboard:', err);
            }
        }

        function updateStats() {
            const confirmed = allRegistrations.filter(r => r.confirmed).length;
            
            document.getElementById('statLideres').textContent = allLeaders.length;
            document.getElementById('statRegistros').textContent = allRegistrations.length;
            document.getElementById('statConfirmados').textContent = confirmed;
            document.getElementById('statEventos').textContent = '1'; // Por ahora
            
            loadRecentRegistrations();
        }

        function loadRecentRegistrations() {
            const recent = allRegistrations.slice(-5).reverse();
            const html = recent.map(r => `
                <tr>
                    <td><strong>${r.firstName} ${r.lastName}</strong></td>
                    <td>${r.email || '-'}</td>
                    <td>${r.leaderName || '-'}</td>
                    <td>${new Date(r.date).toLocaleDateString('es-CO')}</td>
                    <td>
                        <span class="badge ${r.confirmed ? 'bg-success' : 'bg-warning'}">
                            ${r.confirmed ? 'Confirmado' : 'Pendiente'}
                        </span>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('recentRegistrationsTable').innerHTML = html || '<tr><td colspan="5" class="text-center text-muted">Sin registros</td></tr>';
        }

        function loadLeadersTable() {
            const html = allLeaders.map(leader => `
                <tr>
                    <td><strong>${leader.name}</strong></td>
                    <td>${leader.email}</td>
                    <td>${leader.phone || '-'}</td>
                    <td>
                        <span class="badge bg-info">
                            ${allRegistrations.filter(r => r.leaderId === leader._id).length}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showQR('${leader._id}', '${leader.name}')">
                            <i class="bi bi-qr-code"></i> QR
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLeader('${leader._id}')">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('leadersTable').innerHTML = html || '<tr><td colspan="5" class="text-center text-muted">Sin líderes registrados</td></tr>';
            
            // Load filter options
            const options = allLeaders.map(l => `<option value="${l._id}">${l.name}</option>`).join('');
            document.getElementById('filterLeader').innerHTML = '<option value="">Todos los líderes</option>' + options;
            
            const exportOptions = allLeaders.map(l => `<option value="${l._id}">${l.name}</option>`).join('');
            document.getElementById('leaderSelectExport').innerHTML = '<option value="">Selecciona un líder...</option>' + exportOptions;
        }

        function loadRegistrationsTable() {
            const html = allRegistrations.map(reg => `
                <tr>
                    <td><strong>${reg.firstName} ${reg.lastName}</strong></td>
                    <td>${reg.email || '-'}</td>
                    <td>${reg.cedula || '-'}</td>
                    <td>${reg.votingPlace || '-'}</td>
                    <td>${reg.leaderName || '-'}</td>
                    <td>${new Date(reg.date).toLocaleDateString('es-CO')}</td>
                    <td>
                        <span class="badge ${reg.confirmed ? 'bg-success' : 'bg-warning'}">
                            ${reg.confirmed ? 'Confirmado' : 'Pendiente'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleConfirm('${reg._id}', ${reg.confirmed})">
                            <i class="bi bi-check-circle"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('registrationsTable').innerHTML = html || '<tr><td colspan="8" class="text-center text-muted">Sin registros</td></tr>';
        }

        function loadAnalysis() {
            const confirmed = allRegistrations.filter(r => r.confirmed).length;
            const totalRegs = allRegistrations.length;
            const tasa = totalRegs > 0 ? ((confirmed / totalRegs) * 100).toFixed(1) : 0;
            const promedio = allLeaders.length > 0 ? (totalRegs / allLeaders.length).toFixed(1) : 0;
            
            document.getElementById('analysisTasaConfirmacion').textContent = tasa + '%';
            document.getElementById('analysisPromedioRegistros').textContent = promedio;
            
            // Localidades únicas
            const localidades = new Set(allRegistrations.map(r => r.localidad).filter(Boolean));
            document.getElementById('analysisLocalidades').textContent = localidades.size;
            
            // Tabla de líderes
            const lidersStats = allLeaders.map(leader => {
                const regs = allRegistrations.filter(r => r.leaderId === leader._id);
                const conf = regs.filter(r => r.confirmed).length;
                const pct = regs.length > 0 ? ((conf / regs.length) * 100).toFixed(1) : 0;
                const locs = new Set(regs.map(r => r.localidad).filter(Boolean)).size;
                
                return `
                    <tr>
                        <td><strong>${leader.name}</strong></td>
                        <td>${regs.length}</td>
                        <td>${conf}</td>
                        <td>${pct}%</td>
                        <td>${locs}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('analysisLidersTable').innerHTML = lidersStats || '<tr><td colspan="5" class="text-center text-muted">Sin datos</td></tr>';
            
            // Tabla de localidades
            const localidadesCount = {};
            allRegistrations.forEach(r => {
                if (r.localidad) {
                    localidadesCount[r.localidad] = (localidadesCount[r.localidad] || 0) + 1;
                }
            });
            
            const localidadesHtml = Object.entries(localidadesCount)
                .sort((a, b) => b[1] - a[1])
                .map(([localidad, count]) => `
                    <tr>
                        <td><strong>${localidad}</strong></td>
                        <td>${count}</td>
                        <td>${((count / totalRegs) * 100).toFixed(1)}%</td>
                    </tr>
                `).join('');
            
            document.getElementById('analysisLocalidadesTable').innerHTML = localidadesHtml || '<tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>';
        }

        // ============== LÍDERES ==============
        async function saveLeader() {
            const name = document.getElementById('leaderName').value;
            const email = document.getElementById('leaderEmail').value;
            const phone = document.getElementById('leaderPhone').value;
            const area = document.getElementById('leaderArea').value;

            if (!name || !email) {
                alert('Por favor completa los campos requeridos');
                return;
            }

            try {
                const res = await apiCall('/api/leaders', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, area })
                });

                if (res.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('leaderModal')).hide();
                    document.getElementById('leaderName').value = '';
                    document.getElementById('leaderEmail').value = '';
                    document.getElementById('leaderPhone').value = '';
                    document.getElementById('leaderArea').value = '';
                    loadDashboard();
                    alert('Líder creado exitosamente');
                } else {
                    alert('Error creando líder');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error creando líder');
            }
        }

        async function deleteLeader(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este líder?')) {
                try {
                    const res = await apiCall(`/api/leaders/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        loadDashboard();
                        alert('Líder eliminado');
                    }
                } catch (err) {
                    console.error('Error:', err);
                    alert('Error eliminando líder');
                }
            }
        }

        function showQR(leaderId, leaderName) {
            const link = `${API_URL}/registro/${leaderId}`;
            document.getElementById('registrationLink').value = link;
            
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = '';
            
            new QRCode(qrContainer, {
                text: link,
                width: 200,
                height: 200
            });
            
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        }

        function copyLink() {
            const link = document.getElementById('registrationLink');
            link.select();
            document.execCommand('copy');
            alert('Link copiado al portapapeles');
        }

        // ============== REGISTRATIONS ==============
        async function toggleConfirm(id, currentStatus) {
            try {
                const endpoint = currentStatus ? `/api/registrations/${id}/unconfirm` : `/api/registrations/${id}/confirm`;
                const res = await apiCall(endpoint, { method: 'POST' });
                if (res.ok) {
                    loadDashboard();
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // ============== EXPORT ==============
        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Datos');
            XLSX.writeFile(wb, filename);
        }

        function exportRegistrations() {
            const data = allRegistrations.map(r => ({
                'Nombre': `${r.firstName} ${r.lastName}`,
                'Email': r.email || '',
                'Cédula': r.cedula || '',
                'Localidad': r.localidad || '',
                'Puesto Votación': r.votingPlace || '',
                'Mesa': r.votingTable || '',
                'Líder': r.leaderName || '',
                'Fecha': new Date(r.date).toLocaleDateString('es-CO'),
                'Estado': r.confirmed ? 'Confirmado' : 'Pendiente'
            }));
            exportToExcel(data, 'registros.xlsx');
        }

        function exportLeaders() {
            const data = allLeaders.map(l => ({
                'Nombre': l.name,
                'Email': l.email,
                'Teléfono': l.phone || '',
                'Área': l.area || '',
                'Registros': allRegistrations.filter(r => r.leaderId === l._id).length
            }));
            exportToExcel(data, 'lideres.xlsx');
        }

        function exportLeaderData() {
            const leaderId = document.getElementById('leaderSelectExport').value;
            if (!leaderId) {
                alert('Selecciona un líder');
                return;
            }

            const leaderRegs = allRegistrations.filter(r => r.leaderId === leaderId);
            const leader = allLeaders.find(l => l._id === leaderId);
            
            exportToExcel(leaderRegs.map(r => ({
                'Nombre': `${r.firstName} ${r.lastName}`,
                'Email': r.email || '',
                'Cédula': r.cedula || '',
                'Localidad': r.localidad || '',
                'Puesto Votación': r.votingPlace || '',
                'Mesa': r.votingTable || '',
                'Fecha': new Date(r.date).toLocaleDateString('es-CO'),
                'Estado': r.confirmed ? 'Confirmado' : 'Pendiente'
            })), `registros_${leader.name}.xlsx`);
        }

        // ============== SECTION NAVIGATION ==============
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // ============== FILTERS ==============
        document.getElementById('searchInput').addEventListener('input', filterRegistrations);
        document.getElementById('filterLeader').addEventListener('change', filterRegistrations);
        document.getElementById('filterStatus').addEventListener('change', filterRegistrations);

        function filterRegistrations() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const leader = document.getElementById('filterLeader').value;
            const status = document.getElementById('filterStatus').value;

            const filtered = allRegistrations.filter(r => {
                const matchSearch = !search || 
                    r.firstName.toLowerCase().includes(search) ||
                    r.lastName.toLowerCase().includes(search) ||
                    r.email.toLowerCase().includes(search);
                
                const matchLeader = !leader || r.leaderId === leader;
                const matchStatus = !status || (status === 'confirmed' ? r.confirmed : !r.confirmed);
                
                return matchSearch && matchLeader && matchStatus;
            });

            const html = filtered.map(reg => `
                <tr>
                    <td><strong>${reg.firstName} ${reg.lastName}</strong></td>
                    <td>${reg.email || '-'}</td>
                    <td>${reg.cedula || '-'}</td>
                    <td>${reg.votingPlace || '-'}</td>
                    <td>${reg.leaderName || '-'}</td>
                    <td>${new Date(reg.date).toLocaleDateString('es-CO')}</td>
                    <td>
                        <span class="badge ${reg.confirmed ? 'bg-success' : 'bg-warning'}">
                            ${reg.confirmed ? 'Confirmado' : 'Pendiente'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleConfirm('${reg._id}', ${reg.confirmed})">
                            <i class="bi bi-check-circle"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('registrationsTable').innerHTML = html || '<tr><td colspan="8" class="text-center text-muted">Sin resultados</td></tr>';
        }

        // ============== INIT ==============
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadDashboard();
        });
    </script>
</body>
</html>
